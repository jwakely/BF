<?xml version="1.0" encoding="utf-8"?>
<BFCVE ID="CVE-2022-34835" Title="Stack Buffer Overflow in Das U-Boot through 2022.07-rc5" Description="Erroneous declaration of 'nbytes' as int leads of to wrong type, which forces coersion of uint 'lenght' by the assignment operator '=' possibly flippinng (if its first bite is 1) its sign on pass-out. As a result, nbytes is negative and  the condition in 'linebytes = (nbytes &gt; DISP_LINE_LEN) ? DISP_LINE_LEN : nbytes;' evaluates to false and linebytes is assigned a negative value instead of being constrained by 16, which when used to in repositioning on the stack leads to a crush or if a driver truncates it to overbounds pointer, which when used in reading leads to buffer. If exploited, this can lead to arbitrary code execution." Author="Irena Bojanova" Date="2023-10-13T14:00:14" Criteria="denx:u-boot" BugReport="https://lists.denx.de/pipermail/u-boot/2022-June/486113.html" CodeWithBug="https://source.denx.de/u-boot/u-boot/-/commit/8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409" CodeWithFix="https://github.com/u-boot/u-boot/commit/8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409">
  <DefectWeakness Class="DCL" ClassType="_DAT" Language="C" File="u-boot/cmd&#xD;&#xA;/i2c.c" Trace="" Line="473">
    <Cause Comment="nbytes should be uint" Type="Code Defect">Erroneous Code</Cause>
    <Operation Comment="int nbytes">Declare</Operation>
    <Consequence Type="Type">Wrong Type</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Type="Kind">Object</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="int nbytes;" Type="Mechanism">Simple</Attribute>
        <Attribute Comment="u-boot/cmd&#xD;&#xA;/i2c.c" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </DefectWeakness>
  <Weakness Class="TCV" ClassType="_DAT" Language="C" File="u-boot/cmd&#xD;&#xA;/i2c.c" Trace="" Line="531">
    <Cause Comment="wrong type of the passed-out argument from the assignment operator in ‘nbytes = length’" Type="Type">Wrong Type</Cause>
    <Operation Comment="nbytes = length;">Coerce</Operation>
    <Consequence Comment="if the first bit of lenght is 1, it becomes negative when coersed to int" Type="Data">Flipped Sign</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Type="Mechanism">Pass Out</Attribute>
        <Attribute Comment="u-boot/cmd&#xD;&#xA;/i2c.c" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="TCM" ClassType="_DAT" Language="C" File="u-boot/cmd&#xD;&#xA;/i2c.c" Trace="" Line="536">
    <Cause Comment="nbytes is negative" Type="Data">Wrong Argument</Cause>
    <Operation Comment="(nbytes &gt; DISP_LINE_LEN)">Evaluate</Operation>
    <Consequence Comment="condition evaluates to false and linebytes is assigned a wrong value instead of being constrained by 16" Type="Data">Wrong Result</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="More than '&gt;' operator&#xD;&#xA;linebytes = (nbytes &gt; DISP_LINE_LEN) ? DISP_LINE_LEN : nbytes;" Type="Mechanism">Operator</Attribute>
        <Attribute Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="MAD" ClassType="_MEM" Language="C" File="drivers/net/wireless/marvell/mwifiex/ie.c" Trace="" Line="289, 291">
    <Cause Comment="too large for the16 bits buffer at hand" Type="Data">Wrong Size</Cause>
    <Operation Comment="dm_i2c_read or i2c_read">Reposition</Operation>
    <Consequence Comment="if  the used size negative size id not truncated by a driver, this may lead to a crush" Type="Address">Over Bounds Pointer</Consequence>
    <Attributes>
      <Operand Name="Address">
        <Attribute Type="State">Stack</Attribute>
      </Operand>
      <Operand Name="Size">
        <Attribute Type="Kind">Used</Attribute>
      </Operand>
      <Operation>
        <Attribute Type="Mechanism">Sequential</Attribute>
        <Attribute Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="MUS" ClassType="_MEM" Language="C" File="drivers/net/wireless/marvell/mwifiex/ie.c" Trace="" Line="289, 291">
    <Cause Type="Address">Over Bounds Pointer</Cause>
    <Operation Comment="dm_i2c_read or i2c_read">Write</Operation>
    <Consequence Type="Memory Corruption/Disclosure">Buffer Overflow</Consequence>
    <Attributes>
      <Operand Name="Address">
        <Attribute Type="Kind">Huge</Attribute>
        <Attribute Type="State">Stack</Attribute>
      </Operand>
      <Operand Name="Size">
        <Attribute Type="Kind">Used</Attribute>
      </Operand>
      <Operation>
        <Attribute Type="Mechanism">Sequential</Attribute>
        <Attribute Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Failures ClassType="_FLR">
    <Cause Type="Memory Corruption/Disclosure">Buffer Overflow</Cause>
    <Failure Class="ACE" />
  </Failures>
</BFCVE>