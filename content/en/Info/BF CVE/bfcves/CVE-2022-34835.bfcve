<?xml version="1.0" encoding="utf-8"?>
<BFCVE ID="CVE-2022-34835" Title="Stack Buffer Overflow in Das U-Boot through 2022.07-rc5" Description="Erroneous declaration 'int nbytes' (while it should be uint) leads to wrong type of the passed-out argument from the assignment operator in ‘nbytes = length’, which forces coercion of ‘lenght' and possibly flipping (if its first byte is 1) its sign. As a result, ‘nbytes’ is negative, the condition in 'linebytes = (nbytes &gt; DISP_LINE_LEN) ? DISP_LINE_LEN : nbytes;' evaluates to false, and ‘linebytes’ is assigned a negative value, which when used in repositioning on the stack may lead to a crush. Or, if a driver truncates ‘linebytes’ to 16-bit int, then a positive but very large value is used as size leading to  overabounds pointer and buffer overflow. If exploited, this can lead to arbitrary code execution." Author="Irena Bojanova" Date="2023-10-13T14:00:14" Criteria="denx:u-boot" BugReport="https://lists.denx.de/pipermail/u-boot/2022-June/486113.html" CodeWithBug="https://source.denx.de/u-boot/u-boot/-/commit/8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409" CodeWithFix="https://github.com/u-boot/u-boot/commit/8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409">
  <DefectWeakness Class="DCL" ClassType="_DAT" Language="C" File="u-boot/cmd&#xD;&#xA;/i2c.c" Trace="" Line="473">
    <Cause Comment="nbytes should be uint" Type="Code Defect">Erroneous Code</Cause>
    <Operation>Declare</Operation>
    <Consequence Type="Type">Wrong Type</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="nbytes" Type="Kind">Object</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Comment="int" Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="int nbytes;" Type="Mechanism">Simple</Attribute>
        <Attribute Comment="u-boot/cmd&#xD;&#xA;/i2c.c: 473" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </DefectWeakness>
  <Weakness Class="TCV" ClassType="_DAT" Language="C" File="u-boot/cmd&#xD;&#xA;/i2c.c" Trace="" Line="531">
    <Cause Type="Type">Wrong Type</Cause>
    <Operation>Coerce</Operation>
    <Consequence Type="Data">Flipped Sign</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="for passed-out argument" Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="nbytes = length;" Type="Mechanism">Pass Out</Attribute>
        <Attribute Comment="u-boot/cmd&#xD;&#xA;/i2c.c: 531" Type="Source Code">Codebase</Attribute>
        <Attribute Comment="0x80000100 is a negative on 32 bit-platform" Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="TCM" ClassType="_DAT" Language="C" File="u-boot/cmd&#xD;&#xA;/i2c.c" Trace="" Line="536">
    <Cause Type="Data">Wrong Argument</Cause>
    <Operation>Evaluate</Operation>
    <Consequence Type="Data">Under Range</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="nbytes" Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Comment="negative" Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="More than '&gt;' operator in linebytes = (nbytes &gt; DISP_LINE_LEN) ? DISP_LINE_LEN : nbytes;" Type="Mechanism">Operator</Attribute>
        <Attribute Comment="u-boot/cmd&#xD;&#xA;/i2c.c: 536" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="TCV" ClassType="_DAT" Language="C" File="drivers/i2c/nx_i2c.c" Trace="" Line="">
    <Cause Type="Data">Under Range</Cause>
    <Operation>Coerce</Operation>
    <Consequence Type="Data">Truncated Value</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="for passed-in argument" Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Comment="unsigned short is expected" Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="i2c_transfer()" Type="Mechanism">Pass In</Attribute>
        <Attribute Comment="drivers/i2c/nx_i2c.c" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="MAD" ClassType="_MEM" Language="C" File="drivers/net/wireless/marvell/mwifiex/ie.c" Trace="" Line="289, 291">
    <Cause Type="Data">Wrong Size</Cause>
    <Operation>Reposition</Operation>
    <Consequence Type="Address">Over Bounds Pointer</Consequence>
    <Attributes>
      <Operand Name="Address">
        <Attribute Type="State">Stack</Attribute>
      </Operand>
      <Operand Name="Size">
        <Attribute Comment="too large for the16 bits buffer at hand" Type="Kind">Used</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="in dm_i2c_read() or i2c_read()&#xD;&#xA;if  not truncated by a driver, this may lead to a crush" Type="Mechanism">Sequential</Attribute>
        <Attribute Comment="u-boot/cmd&#xD;&#xA;/i2c.c: 289, 291" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="MUS" ClassType="_MEM" Language="C" File="u-boot/cmd&#xD;&#xA;/i2c.c" Trace="" Line="289, 291">
    <Cause Type="Address">Over Bounds Pointer</Cause>
    <Operation>Write</Operation>
    <Consequence Type="Memory Corruption/Disclosure">Buffer Overflow</Consequence>
    <Attributes>
      <Operand Name="Address">
        <Attribute Comment="16 bit integer can be much larger than the buffer size 16" Type="Kind">Huge</Attribute>
        <Attribute Type="State">Stack</Attribute>
      </Operand>
      <Operand Name="Size">
        <Attribute Type="Kind">Used</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="in dm_i2c_read() or i2c_read()" Type="Mechanism">Sequential</Attribute>
        <Attribute Comment="u-boot/cmd&#xD;&#xA;/i2c.c: 289, 291" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Failures ClassType="_FLR">
    <Cause Type="Memory Corruption/Disclosure">Buffer Overflow</Cause>
    <Failure Class="ACE" />
  </Failures>
</BFCVE>