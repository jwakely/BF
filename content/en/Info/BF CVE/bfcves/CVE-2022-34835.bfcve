<?xml version="1.0" encoding="utf-8"?>
<BFCVE ID="CVE-2022-34835" Title="Stack Buffer Overflow in Das U-Boot through 2022.07-rc5" Description="Erroneous declaration of ‘nbytes’ as int leads to wrong argument type for the uint ‘length’ in ‘nbytes = length’, leading to a flipped sign, and under range negative ‘linebytes’ truncated to a large integer, allowing pointer reposition over bounds, which, when used in i2c_transfer() leads to stack buffer overflow. If exploited, this can lead to denial of service – program crash, and possibly arbitrary code execution." Author="Irena Bojanova, Eduard Pinconschi" Date="2023-10-13T14:00:14" Criteria="denx:u-boot" BugReport="https://lists.denx.de/pipermail/u-boot/2022-June/486113.html" CodeWithBug="https://source.denx.de/u-boot/u-boot/-/commit/8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409" CodeWithFix="https://github.com/u-boot/u-boot/commit/8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409">
  <DefectWeakness Class="DCL" ClassType="_DAT" Language="C" File="u-boot/cmd/i2c.c" Trace="" Line="473">
    <Cause Type="Code Defect">Erroneous Code</Cause>
    <Operation Comment="int nbytes;">Declare</Operation>
    <Consequence Type="Type">Wrong Type</Consequence>
    <Attributes>
      <Operand Name="Type">
        <Attribute Comment="int, while should be uint" Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Type="Mechanism">Simple</Attribute>
        <Attribute Comment="u-boot/cmd/i2c.c: 473" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </DefectWeakness>
  <Weakness Class="TCV" ClassType="_DAT" Language="C" File="u-boot/cmd/i2c.c" Trace="" Line="531">
    <Cause Type="Type">Wrong Type</Cause>
    <Operation Comment="nbytes = length;">Coerce</Operation>
    <Consequence Type="Data">Flipped Sign</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="lenght" Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Comment="uint parsed from 'i2c md 0 0 80000100' by do_i2c_md()" Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Comment="uint" Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="'lenght' from '=' operator" Type="Mechanism">Pass Out</Attribute>
        <Attribute Comment="u-boot/cmd/i2c.c: 531" Type="Source Code">Codebase</Attribute>
        <Attribute Comment="0x80000100 is negative on 32 bit-platform" Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="TCM" ClassType="_DAT" Language="C" File="u-boot/cmd/i2c.c" Trace="" Line="536">
    <Cause Type="Data">Wrong Argument</Cause>
    <Operation Comment="linebytes = (nbytes &gt; DISP_LINE_LEN) ? DISP_LINE_LEN : nbytes;">Evaluate</Operation>
    <Consequence Type="Data">Under Range</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="linebytes" Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Comment="negative" Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="more than '&gt;'" Type="Mechanism">Operator</Attribute>
        <Attribute Comment="u-boot/cmd/i2c.c: 536" Type="Source Code">Codebase</Attribute>
        <Attribute Comment="linebytes is negative instead f 16" Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="TCV" ClassType="_DAT" Language="C" File="u-boot/drivers/i2c&#xD;&#xA;/nx_i2c.c" Trace="" Line="472">
    <Cause Type="Data">Under Range</Cause>
    <Operation Comment="nx_i2c_read()">Coerce</Operation>
    <Consequence Type="Data">Truncated Value</Consequence>
    <Attributes>
      <Operand Name="Name">
        <Attribute Comment="linebytes is 0x80000100" Type="State">Resolved</Attribute>
      </Operand>
      <Operand Name="Data">
        <Attribute Type="Kind">Numeric</Attribute>
      </Operand>
      <Operand Name="Type">
        <Attribute Type="Kind">Primitive</Attribute>
      </Operand>
      <Operation>
        <Attribute Comment="expects unsigned short length" Type="Mechanism">Pass In</Attribute>
        <Attribute Comment="u-boot/drivers/i2c&#xD;&#xA;/nx_i2c.c: 472" Type="Source Code">Codebase</Attribute>
        <Attribute Comment="if not truncated by a driver may lead to a crash" Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="MAD" ClassType="_MEM" Language="C" File="u-boot/drivers/i2c&#xD;&#xA;/nx_i2c.c" Trace="" Line="449">
    <Cause Type="Data">Wrong Size</Cause>
    <Operation Comment="i2c_transfer()">Reposition</Operation>
    <Consequence Type="Address">Over Bounds Pointer</Consequence>
    <Attributes>
      <Operand Name="Address">
        <Attribute Type="State">Stack</Attribute>
      </Operand>
      <Operand Name="Size">
        <Attribute Comment="too large for the 16-bit buffer at hand" Type="Kind">Used</Attribute>
      </Operand>
      <Operation>
        <Attribute Type="Mechanism">Sequential</Attribute>
        <Attribute Comment="u-boot/drivers/i2c&#xD;&#xA;/nx_i2c.c: 449" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Weakness Class="MUS" ClassType="_MEM" Language="C" File="u-boot/drivers/i2c&#xD;&#xA;/nx_i2c.c" Trace="" Line="449">
    <Cause Type="Address">Over Bounds Pointer</Cause>
    <Operation Comment="data[i++] = readb(&amp;i2c-&gt;iicds);">Write</Operation>
    <Consequence Type="Memory Corruption/Disclosure">Buffer Overflow</Consequence>
    <Attributes>
      <Operand Name="Address">
        <Attribute Type="State">Stack</Attribute>
      </Operand>
      <Operand Name="Size">
        <Attribute Type="Kind">Used</Attribute>
      </Operand>
      <Operation>
        <Attribute Type="Mechanism">Sequential</Attribute>
        <Attribute Comment="u-boot/drivers/i2c&#xD;&#xA;/nx_i2c.c: 449" Type="Source Code">Codebase</Attribute>
        <Attribute Type="Execution Space">Bare-Metal</Attribute>
      </Operation>
    </Attributes>
  </Weakness>
  <Failures ClassType="_FLR">
    <Cause Type="Memory Corruption/Disclosure">Buffer Overflow</Cause>
    <Failure Class="ACE" />
    <Failure Class="DOS" />
  </Failures>
</BFCVE>